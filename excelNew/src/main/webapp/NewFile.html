<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>excelDownload</title>
		  jquery 
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
		
		[CDN 설정 실시] 
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
   		<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
	</head>
	<body>
		<button id="excelBtn">엑셀 다운로드</button>
		
		<script>
			let arr = [];
			$("#excelBtn").click(function() {
				// alert("excelBtn"); 디버깅
				$.ajax({
					async : false,
					url : '/excel',
					type: 'GET',
					// data: json -> sheet.js 자료구조 -> 다운로드
					success : function(data) { 
						$(data).each(function(index, item) { 
							let row = [];
							arr.push(item.name);
							arr.push(item.age);
							arr.push(row);
						}); 
					}
					// {name: "루피", age:17}, {name: "나미", age: 19}
					
				});
				// 1) 엑셀 파일 
				let book = XLSX.utils.book_new(); // 엑셀 파일
				// 2) 1) 안에 시트 이름 생성
				book.SheetNames.push('one');
				
				// 3) 시트 생성
				let sheet = XLSX.utils.aoa_to_sheet(arr); // book과 sheet는 별개
				
				// 2) 와 3) 을 연결
				book.Sheets['one'] = sheet;
				
				// 4) boot -> 기계어 파일로
				let source = XLSX.write(book, {bookType: 'xlsx', type: 'binary'});
				
				// 다운로드
				// 1) source 크기의 빈 스트림 생성
				let buf = new ArrayBuffer(source.length);
				
				// 2) 8비트 배열로 버퍼 랩핑 -> 1byte씩 옮기기 위해
				let buf2 = new Uint8Array(buf);
				
				for (let i = 0; i < source.length; i++) {
					buf2[i] = source.charCodeAt(i) & 0xFF;
				}
				
				let b = new Blob([buf], {type: "application/octet-stream"});
				saveAs(b, "test.xlsx");
			});	
			
		</script>
	</body>
</html>